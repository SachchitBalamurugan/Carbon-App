<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
}

body {
    display: flex;
    background-color: #ffffff;
}

.sidebar {
            width: 60px;
            background-color: #F1F1F1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
        }
        .icon {
            width: 50px;
            height: 70px;
            color: #030303;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }
        .icon:hover {
            background-color: #8EF913;
            border-radius: 5px;
        }

.main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 20px;
}

header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

header input[type="text"] {
    width: 60%;
    padding: 10px;
    border-radius: 20px;
    border: 1px solid #ccc;
}

.profile {
    display: flex;
    align-items: center;
}

.profile p {
    margin-right: 10px;
}

.profile-pic {
    width: 40px;
    height: 40px;
    background-color: #ccc;
    border-radius: 50%;
}

.content {
    display: flex;
    flex: 1;
    margin-top: 20px;
}

.main-section {
    flex: 2;
    margin-right: 20px;
}

.stats-section {
    width: 500px;
}

.greeting {
    margin: 20px 0;
}

.activities, .emissions-saved{
    background-color: #F1F1F1;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.activities2{
    background-color: #E8F9D4;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.stats {
    background-color: #F1F1F1;
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 10px;
}

.activities2 .activities h2, .emissions-saved h2, .stats h2 {
    margin-bottom: 10px;
}

.activity-card {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
}

.user-pic {
    width: 40px;
    height: 40px;
    background-color: #ccc;
    border-radius: 50%;
    margin-right: 10px;
}

.activity-card p {
    margin-right: 10px;
}

button {
    padding: 10px 20px;
    border: none;
    border-radius: 20px;
    background-color: #000;
    color: #fff;
    cursor: pointer;
}

button:hover {
    background-color: #333;
}

.chart {
    height: 200px;
    background-color: #e0e0e0;
    border-radius: 10px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    margin-bottom: 10px;
}

.stats-grid div {
    text-align: center;
    padding: 10px;
    background-color: #ffffff;
    border-radius: 10px;
}

.plans {
    margin-bottom: 10px;
}

.plan-card {
    background-color: #ffffff;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 10px;
}

/* Responsive styles */
@media (max-width: 1200px) {
    .main-content {
        padding: 10px;
    }
    
    header input[type="text"] {
        width: 50%;
    }

    .stats-section {
        width: 300px;
    }
}

@media (max-width: 992px) {
    body {
        flex-direction: column;
    }

    .sidebar {
        width: 100%;
        flex-direction: row;
        justify-content: space-around;
    }

    .main-content {
        padding: 10px;
    }
    
    header {
        flex-direction: column;
        align-items: flex-start;
    }

    header input[type="text"] {
        width: 100%;
        margin-bottom: 10px;
    }

    .content {
        flex-direction: column;
    }

    .main-section {
        margin-right: 0;
    }

    .stats-section {
        width: 100%;
        margin-top: 20px;
    }
}

@media (max-width: 768px) {
    .sidebar {
        padding: 10px 0;
    }

    .icon {
        width: 30px;
        height: 30px;
    }

    .profile-pic {
        width: 30px;
        height: 30px;
    }

    button {
        padding: 8px 16px;
        border-radius: 15px;
    }

    .stats-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 576px) {
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

    </style>
</head>
<body>
    <div class="sidebar">
        <a href="/" class="icon"><i class="fa-solid fa-table-columns fa-xl"></i></a>
        <a href="/dashboard" class="icon"><i class="fa-solid fa-share-nodes fa-xl"></i></a>
        <a href="/profile" class="icon"><i class="fa-solid fa-user-group fa-xl"></i></a>
        <a href="/settings" class="icon"><i class="fa-solid fa-calendar fa-xl"></i></a>
        <a href="/statistics" class="icon"><i class="fa-solid fa-table-columns fa-xl"></i></a>
    </div>
    
    <div class="main-content">
        <header>
            <input type="text" placeholder="Search activities, goals, and tips">
            <div class="profile">
                <div style="margin-right: 10px;" class="profile-pic"></div>
                <p>{{username}}</p>
                <button onclick="window.location.href='/logout'">Logout</button>

            </div>
        </header>
        <div class="content">
            <div class="main-section">
                <div class="greeting" style="margin-bottom: 45px;">
                    <h1 style="margin-bottom: 10px; font-size: 25px;">Carbon Tracker Dashboard {{percentDecrease}}</h1>
                </div>
                <div style="display: flex; justify-content: space-between; gap: 20px;">
                    <div class="activities" style="flex: 1;">
                        <h2 style="margin-bottom: 17px; font-size: 20px; color: #5D5D5B; font-weight: 300;">Track your carbon footprint</h3>
                        <h2 id="percent-change" style="margin-bottom: 17px; font-size: 20px; color: #5D5D5B; font-weight: 300;">Track your carbon footprint</h3>
                        <h2  style="margin-bottom: 17px; font-size: 15px; color: #5D5D5B; font-weight: 300;">Compared to last date</h3>
                    </div>
                    <div class="activities" style="flex: 1;">
                        <!-- <h3 style="margin-bottom: 17px; font-size: 20px; color: #5D5D5B; font-weight: 300;">Total CO2 emissions saved</h3> -->
                        <h2 id="total-emissions" style="margin-bottom: 17px; font-size: 25px; color: #1c1c1c; font-weight: bold;">$1.432 equivalent</h3>
                        <!-- <h3 style="margin-bottom: 17px; font-size: 15px; color: #5D5D5B; font-weight: 300;">Compared to previous month</h3> -->
                        <div id="previous-day-emissions"></div>
                    </div>
                </div>
                
                
                <h2>Total Emissions by Category</h2>
                 <!-- Chart -->
                 <div style="position: relative; width: 100%; height: 300px;">
                    <canvas id="myBarChart"></canvas>
                </div>
            
                <!-- Firebase scripts -->
<script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script defer src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script defer src="{{ url_for('static', filename='init-firebase.js') }}"></script>

<!-- Chart.js script -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Initialize the chart -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
    // Initialize Chart.js
    const ctx = document.getElementById('myBarChart').getContext('2d');
    //percent decrease
    function fetchEmissionsData(currentDay, previousDay) {
    var userId = "{{ user_id }}"; // Assuming user_id is passed from Flask

    // Firestore references
    const userActivitiesRef = db.collection("users").doc(userId).collection("activities");

    // Query emissions for the current day
    let currentDayEmissions = 0;
    let previousDayEmissions = 0;

    db.collection("users").doc(userId).collection("activities").where("day", "==", currentDay).get()
        .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                let emissions = parseFloat(data.emissions);
                let quantity = parseFloat(data.quantity);

                if (!isNaN(emissions) && !isNaN(quantity)) {
                    currentDayEmissions += emissions * quantity;
                }
            });

            // Query emissions for the previous day
            return userActivitiesRef.where("day", "==", previousDay).get();
        })
        .then((querySnapshot) => {
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                let emissions = parseFloat(data.emissions);
                let quantity = parseFloat(data.quantity);

                if (!isNaN(emissions) && !isNaN(quantity)) {
                    previousDayEmissions += emissions * quantity;
                }
            });

            // Calculate the percent decrease
            let percentDecrease = 0;
            if (previousDayEmissions > 0) {
                percentDecrease = ((previousDayEmissions - currentDayEmissions) / previousDayEmissions) * 100;
            }

           // Update the HTML with the percent decrease and make it bold
document.querySelector("h3").innerHTML = `<strong>${percentDecrease.toFixed(2)}%</strong> decrease in`;


        })
        .catch((error) => {
            console.error("Error fetching emissions data: ", error);
        });
}

// Example usage
const currentDay = new Date().toLocaleDateString(); // Get current day
const previousDay = new Date();
previousDay.setDate(previousDay.getDate() - 1); // Get previous day

fetchEmissionsData(currentDay, previousDay.toLocaleDateString());
let myBarChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Transportation', 'Food', 'Household', 'Manufacturing', 'Environmental', 'Total'],
        datasets: [{
            label: 'CO2 Emissions',
            data: [0, 0, 0, 0, 0, 0], // This will be populated with Firebase data
            backgroundColor: [
                '#E8F9D4', // Transportation
                '#E8F9D4', // Food
                '#E8F9D4', // Household
                '#E8F9D4', // Manufacturing
                '#E8F9D4', // Environmental
                '#E8F9D4'  // Total
            ],
            borderColor: [
                '#8EF913', // Transportation
                '#8EF913', // Food
                '#8EF913', // Household
                '#8EF913', // Manufacturing
                '#8EF913', // Environmental
                '#8EF913'  // Total
            ],
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                beginAtZero: true
            },
            y: {
                beginAtZero: true,
                max: 300 // This will be updated dynamically
            }
        },
        plugins: {
            legend: {
                display: true,
                position: 'top'
            },
            tooltip: {
                callbacks: {
                    label: function(tooltipItem) {
                        return tooltipItem.dataset.label + ': ' + tooltipItem.raw;
                    }
                }
            }
        }
    }
});
var userId = "{{ user_id }}";

// Fetch data from Firestore and update chart
db.collection("users").doc(userId).collection("activities").get().then((querySnapshot) => {
    if (querySnapshot.empty) {
        console.log('No matching documents.');
    } else {
        let emissionsData = {
            transportation: 0,
            food: 0,
            household: 0,
            manufacturing: 0,
            environmental: 0,
            total: 0
        };

        querySnapshot.forEach((doc) => {
            let data = doc.data();
            let category = data.category;
            let emissions = parseFloat(data.emissions); // Convert to number
            let quantity = parseFloat(data.quantity); // Convert to number

            if (!isNaN(emissions) && !isNaN(quantity)) {
                let totalEmissions = emissions * quantity;
                if (emissionsData.hasOwnProperty(category)) {
                    emissionsData[category] += totalEmissions;
                }
                emissionsData.total += totalEmissions;
            }
        });

        console.log('Emissions data:', emissionsData); // Log the calculated emissions data

        // Calculate maximum value for y-axis
        let maxEmissions = Math.max(
            emissionsData.transportation,
            emissionsData.food,
            emissionsData.household,
            emissionsData.manufacturing,
            emissionsData.environmental,
            emissionsData.total
        );

        // Ensure the maximum value is at least 300, and move it up 100 units if it exceeds 300
        let yMax = maxEmissions > 300 ? Math.ceil(maxEmissions / 100) * 100 : 300;

        // Update chart data
        myBarChart.data.datasets[0].data = [
            emissionsData.transportation ,
            emissionsData.food ,
            emissionsData.household ,
            emissionsData.manufacturing ,
            emissionsData.environmental ,
            emissionsData.total 
        ];

        // Update y-axis max value
        myBarChart.options.scales.y.max = yMax;
        myBarChart.update();
    }
}).catch((error) => {
    console.error("Error getting documents: ", error);
});


});




</script>

<script>
    // document.addEventListener('DOMContentLoaded', () => {
    //     function formatDate(date) {
    //         return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
    //     }

    //     function fetchEmissionsForDate(userId, date) {
    //         const userActivitiesRef = db.collection("users").doc(userId).collection("activities");
    //         return userActivitiesRef.where("timestamp", ">=", new Date(date + 'T00:00:00Z'))
    //             .where("timestamp", "<", new Date(date + 'T23:59:59Z'))
    //             .get()
    //             .then((querySnapshot) => {
    //                 let totalEmissions = 0;
    //                 querySnapshot.forEach((doc) => {
    //                     const data = doc.data();
    //                     const emissions = parseFloat(data.emissions);
    //                     const quantity = parseFloat(data.quantity);
    //                     if (!isNaN(emissions) && !isNaN(quantity)) {
    //                         totalEmissions += emissions * quantity;
    //                     }
    //                 });
    //                 return totalEmissions;
    //             });
    //     }

    //     function displayEmissions(userId) {
    //         const today = formatDate(new Date());
    //         const yesterday = formatDate(new Date(new Date().setDate(new Date().getDate() - 1)));

    //         // Fetch emissions data for today and the previous day
    //         Promise.all([
    //             fetchEmissionsForDate(userId, today),
    //             fetchEmissionsForDate(userId, yesterday)
    //         ]).then(([todayEmissions, yesterdayEmissions]) => {
    //             // Update the HTML with the total emissions for today and the previous day
    //             document.getElementById("total-emissions").textContent = `Total emissions for today: ${todayEmissions.toFixed(2)} kg`;
    //             document.getElementById("previous-day-emissions").textContent = `Total emissions for the previous day: ${yesterdayEmissions.toFixed(2)} kg`;

    //             // Calculate percent change
    //             let percentChange = 0;
    //             if (yesterdayEmissions > 0) {
    //                 percentChange = ((todayEmissions - yesterdayEmissions) / yesterdayEmissions) * 100;
    //             } else if (todayEmissions > 0) {
    //                 percentChange = 100; // If there were no emissions yesterday but there are today, this is considered a 100% increase
    //             }

    //             // Determine change direction
    //             let changeDirection = percentChange > 0 ? 'increase' : 'decrease';

    //             // Update the HTML with percent change
    //             document.getElementById("percent-change").textContent = `Percent ${changeDirection}: ${percentChange.toFixed(2)}%`;

    //             // Calculate and update points based on percent change
    //             let earnedPoints = 0;
    //             if (percentChange <= -20) {
    //                 earnedPoints = 200; // 20% decrease or more
    //             } else if (percentChange <= -10) {
    //                 earnedPoints = 100; // 10% decrease
    //             } else if (percentChange > 0) {
    //                 earnedPoints = 50; // For increases, a smaller reward
    //             }

    //             document.getElementById("earned-points").textContent = `Earned points: ${earnedPoints}`;

    //         }).catch((error) => {
    //             console.error("Error fetching emissions data: ", error);
    //         });
    //     }

    //     const userId = "{{ user_id }}"; // Assuming user_id is passed from Flask
    //     displayEmissions(userId);
    // });
    document.addEventListener('DOMContentLoaded', () => {
    function formatDateToISO(date) {
        return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
    }

    function getStartAndEndOfDay(date) {
        // Ensure the times are in UTC
        const startOfDay = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0));
        const endOfDay = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59));
        return { startOfDay, endOfDay };
    }

    

    // Assuming you have already initialized Firebase
// Initialize Firestore
const db = firebase.firestore();

function fetchEmissionsForDate(userId, date) {
    const userActivitiesRef = db.collection("users").doc(userId).collection("activities");

    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0); // Start of the day

    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999); // End of the day

    return userActivitiesRef
        .where("timestamp", ">=", startOfDay)
        .where("timestamp", "<=", endOfDay)
        .get()
        .then((querySnapshot) => {
            let totalEmissions = 0;
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const emissions = parseFloat(data.emissions);
                const quantity = parseFloat(data.quantity);
                if (!isNaN(emissions) && !isNaN(quantity)) {
                    totalEmissions += emissions * quantity;
                }
            });
            return totalEmissions; // Return the total emissions
        });
}
function fetchLastRecordedEmissions(userId) {
    const userActivitiesRef = db.collection("users").doc(userId).collection("activities");
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0); // Start of today

    return userActivitiesRef
        .where("timestamp", "<", todayStart) // Get records before today
        .orderBy("timestamp", "desc") // Order by timestamp in descending order
        .limit(1) // Get the latest one
        .get()
        .then((querySnapshot) => {
            if (querySnapshot.empty) {
                return 0; // Return 0 if no records found
            }

            const recentDoc = querySnapshot.docs[0];
            const recentTimestamp = recentDoc.data().timestamp.toDate(); // Get the timestamp of the last recorded date

            // Now, fetch all records for that specific date
            return userActivitiesRef
                .where("timestamp", ">=", new Date(recentTimestamp.setHours(0, 0, 0, 0))) // Start of the day
                .where("timestamp", "<=", new Date(recentTimestamp.setHours(23, 59, 59, 999))) // End of the day
                .get()
                .then((dateSnapshot) => {
                    let totalEmissions = 0;
                    dateSnapshot.forEach((doc) => {
                        const data = doc.data();
                        const emissions = parseFloat(data.emissions);
                        const quantity = parseFloat(data.quantity);
                        if (!isNaN(emissions) && !isNaN(quantity)) {
                            totalEmissions += emissions * quantity; // Sum total emissions for that date
                        }
                    });
                    return totalEmissions; // Return the total emissions for the last recorded day
                });
        });
}

function displayEmissions(userId) {
    const today = new Date();

    // Fetch emissions data for today and the last recorded day
    Promise.all([
        fetchEmissionsForDate(userId, today), // Function for today's emissions
        fetchLastRecordedEmissions(userId) // New function for the last recorded emissions
    ]).then(([todayEmissions, lastRecordedEmissions]) => {
        // Check if the elements exist before updating their content
        const totalEmissionsElement = document.getElementById("total-emissions");
        const previousDayEmissionsElement = document.getElementById("previous-day-emissions");
        const percentChangeElement = document.getElementById("percent-change");

        if (totalEmissionsElement) {
            totalEmissionsElement.textContent = `Total emissions for today: ${todayEmissions.toFixed(2)} kg`;
        }

        if (previousDayEmissionsElement) {
            previousDayEmissionsElement.textContent = `Total emissions for the last recorded day: ${lastRecordedEmissions.toFixed(2)} kg`;
        }

        // Calculate percent change
        let percentChange = 0;
if (lastRecordedEmissions > 0) {
    percentChange = ((todayEmissions - lastRecordedEmissions) / lastRecordedEmissions) * 100;
} else if (todayEmissions > 0) {
    percentChange = 100; // If there were no emissions on the last recorded day but there are today, this is considered a 100% increase
}

// Update the HTML with percent change
if (percentChangeElement) {
    percentChangeElement.textContent = `Percent change: ${percentChange.toFixed(2)}%`;
}


        // Additional logic for points can go here if needed
    }).catch((error) => {
        console.error("Error fetching emissions data: ", error);
    });
}

// Usage
const userId = "{{ user_id }}"; // Assuming user_id is passed from Flask
displayEmissions(userId);

});


</script>



<!-- 
<p id="earned-points">Earned points: 0.00</p>
<p id="total-emissions">Total emissions saved: 0.00 kg</p> -->
<!-- 
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ctx = document.getElementById('myBarChart').getContext('2d');

        function formatDate(date) {
            return date.toISOString().split('T')[0]; // Format as YYYY-MM-DD
        }

        function fetchAndProcessEmissions(userId) {
            const userActivitiesRef = db.collection("users").doc(userId).collection("activities");

            // Query all documents ordered by timestamp
            userActivitiesRef.orderBy("timestamp", "asc").get()
                .then((querySnapshot) => {
                    var dailyTotals = {};
                    var sortedDates = [];

                    querySnapshot.forEach((doc) => {
                        var data = doc.data();
                        var date = new Date(data.timestamp.toDate()).toLocaleDateString(); // Format date
                        var emissions = parseFloat(data.emissions);
                        var quantity = parseFloat(data.quantity);

                        if (!isNaN(emissions) && !isNaN(quantity)) {
                            var totalEmissions = emissions * quantity;

                            if (!dailyTotals[date]) {
                                dailyTotals[date] = 0;
                                sortedDates.push(date); // Add date to sortedDates array
                            }
                            dailyTotals[date] += totalEmissions;
                        }
                    });

                    // Sort dates
                    sortedDates.sort((a, b) => new Date(a) - new Date(b));

                    // Compute differences between dates
                    var points = [];
                    var previousPoints = 0;

                    sortedDates.forEach((date, index) => {
                        var currentPoints = dailyTotals[date];
                        var difference = index === 0 ? currentPoints : currentPoints - previousPoints;
                        points.push(difference);
                        previousPoints = currentPoints;
                    });

                    // Update chart with differences
                    myBarChart.data.labels = sortedDates;
                    myBarChart.data.datasets[0].data = points;
                    myBarChart.update();

                    // Update totals
                    var totalEmissions = sortedDates.reduce((sum, date) => sum + dailyTotals[date], 0);
                    var totalPoints = totalEmissions; // Assuming 1 kg CO2 = 1 point

                    document.getElementById("earned-points").textContent = `Earned points: ${totalPoints.toFixed(2)}`;
                    document.getElementById("total-emissions").textContent = `Total emissions saved: ${totalEmissions.toFixed(2)} kg`;

                    // Update activity list
                    var activityList = document.getElementById("activity-list");
                    activityList.innerHTML = ''; // Clear previous entries

                    querySnapshot.forEach((doc) => {
                        var data = doc.data();
                        var activityCard = document.createElement("div");
                        activityCard.className = "activity-card";
                        activityCard.innerHTML = `
                            <div class="user-pic"></div>
                            <p>${data.activity} (${data.category})</p>
                            <p>Quantity: ${data.quantity}</p>
                            <p>CO2 Emissions: ${data.emissions} kg</p>
                        `;
                        activityList.appendChild(activityCard);
                    });
                })
                .catch((error) => {
                    console.error("Error fetching emissions data: ", error);
                });
        }

        const userId = "{{ user_id }}"; // Assuming user_id is passed from Flask
        fetchAndProcessEmissions(userId);

        // Initialize Chart.js if needed
        let myBarChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [], // Will be updated dynamically
                datasets: [{
                    label: 'CO2 Emissions',
                    data: [], // Will be updated dynamically
                    backgroundColor: '#E8F9D4',
                    borderColor: '#8EF913',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true,
                        max: 300 // Adjust this as needed
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(tooltipItem) {
                                return tooltipItem.dataset.label + ': ' + tooltipItem.raw;
                            }
                        }
                    }
                }
            }
        });
    });
</script> -->

                  

                <!-- Chart -->
                <h2>Today's Emissions by Category</h2>
<canvas style="margin-top: 10px; margin-bottom: 10px;" id="emissionsChart" width="400" height="200"></canvas>

<h2>Percent Change From Last Time Emissions by Category</h2>
<canvas id="percentChart" width="400" height="200"></canvas>

                  
            </div>
            <div class="stats-section">
                <div class="stats">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <h2 style="margin: 0;">Community</h2>
                        <button style="margin-left: auto;">View today's announcements</button>
                    </div>   
                                     
                    <div class="plans">
                        
                        <div class="plan-card" style="background-color: #8EF913;">
                            
                            <div style="display: flex; align-items: center;">
                                
                                <div style="display: inline-block; margin-left: 10px;">
                                    <p style="font-weight: bold;">Discover eco-friendly events near you</p>
                                    <p style="color: #030303; margin-top: 25px;">Posted 5 mins ago</p>
                                </div>
                                <div style="margin-left: 55px; color: #5D5D5B;">
                                    <i class="fa-solid fa-thumbtack" style="color: #000000; margin-right: 10px;"></i>
                                    <i class="fa-solid fa-ellipsis" style="color: #000000;"></i>
                                </div>
                            </div>
                    
                            
                        </div>
                        <div class="plan-card" style="background-color: #8EF913;">
                            
                            <div style="display: flex; align-items: center;">
                                
                                <div style="display: inline-block; margin-left: 10px;">
                                    <p style="font-weight: bold;">Discover eco-friendly events near you</p>
                                    <p style="color: #030303; margin-top: 25px;">Posted 5 mins ago</p>
                                </div>
                                <div style="margin-left: 55px; color: #5D5D5B;">
                                    <i class="fa-solid fa-thumbtack" style="color: #000000; margin-right: 10px;"></i>
                                    <i class="fa-solid fa-ellipsis" style="color: #000000;"></i>
                                </div>
                            </div>
                    
                            
                        </div>
                        <div class="plan-card" style="background-color: #8EF913;">
                            
                            <div style="display: flex; align-items: center;">
                                
                                <div style="display: inline-block; margin-left: 10px;">
                                    <p style="font-weight: bold;">Discover eco-friendly events near you</p>
                                    <p style="color: #030303; margin-top: 25px;">Posted 5 mins ago</p>
                                </div>
                                <div style="margin-left: 55px; color: #5D5D5B;">
                                    <i class="fa-solid fa-thumbtack" style="color: #000000; margin-right: 10px;"></i>
                                    <i class="fa-solid fa-ellipsis" style="color: #000000;"></i>
                                </div>
                            </div>
                    
                            
                        </div>
                        <div class="plan-card" style="background-color: #8EF913;">
                            
                            <div style="display: flex; align-items: center;">
                                
                                <div style="display: inline-block; margin-left: 10px;">
                                    <p style="font-weight: bold;">Discover eco-friendly events near you</p>
                                    <p style="color: #030303; margin-top: 25px;">Posted 5 mins ago</p>
                                </div>
                                <div style="margin-left: 55px; color: #5D5D5B;">
                                    <i class="fa-solid fa-thumbtack" style="color: #000000; margin-right: 10px;"></i>
                                    <i class="fa-solid fa-ellipsis" style="color: #000000;"></i>
                                </div>
                            </div>
                    
                            
                        </div>
                        <div class="plan-card" style="background-color: #8EF913;">
                            
                            <div style="display: flex; align-items: center;">
                                
                                <div style="display: inline-block; margin-left: 10px;">
                                    <p style="font-weight: bold;">Discover eco-friendly events near you</p>
                                    <p style="color: #030303; margin-top: 25px;">Posted 5 mins ago</p>
                                </div>
                                <div style="margin-left: 55px; color: #5D5D5B;">
                                    <i class="fa-solid fa-thumbtack" style="color: #000000; margin-right: 10px;"></i>
                                    <i class="fa-solid fa-ellipsis" style="color: #000000;"></i>
                                </div>
                            </div>
                    
                            
                        </div>
                    </div>
                    <button style="background-color: #000000; width: 100%;">View all announcements</button>
                </div>
                
                
                <div id="event-list">
                    <!-- Event data will be populated here -->
                </div>
                
                <!-- <div style="display: flex; justify-content: space-between; gap: 20px;">
                    <div class="activities2" style="flex: 1;">
                        <div>
                            <h3 style="margin-bottom: 17px; font-size: 20px; color: #333333; font-weight: 300;">Recent Eco-Activities</h3>
                            <h3 style="margin-bottom: 17px; font-size: 15px; color: #5D5D5B; font-weight: 300;">10:40 AM, Fri., Sept. 10, 2021</h3>
                            <h3 style="margin-bottom: 17px; font-size: 17px; color: #5D5D5B; font-weight: 300;">You planted a tree in a local park</h3>
                            <h3 style="margin-bottom: 17px; font-size: 17px; color: #5D5D5B; font-weight: 300;">Check the tree's growth progress and contribution to the environment.</h3>
                        </div>
                        <div>
                            <h3 style="margin-bottom: 17px; font-size: 20px; color: #333333; font-weight: 300;">Recent Eco-Activities</h3>
                            <h3 style="margin-bottom: 17px; font-size: 15px; color: #5D5D5B; font-weight: 300;">10:40 AM, Fri., Sept. 10, 2021</h3>
                            <h3 style="margin-bottom: 17px; font-size: 17px; color: #5D5D5B; font-weight: 300;">You planted a tree in a local park</h3>
                            <h3 style="margin-bottom: 17px; font-size: 17px; color: #5D5D5B; font-weight: 300;">Check the tree's growth progress and contribution to the environment.</h3>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <h3 style="font-size: 15px; color: #5D5D5B; font-weight: 300; margin-right: 10px;">
                                Today you saved 12kg of CO2 emissions
                            </h3>
                            <button style="background-color: #8EF913; font-size: 16px; font-weight: bold;">View all eco-tasks</button>
                        </div>                        
                    </div>          
                </div> -->
                 <!-- Button to trigger the AI response -->
    <button id="getAiResponse">Get AI Reccomendations to reduce emmissions</button>

    <!-- Div to display the AI response -->
    <div id="aiResponse" style="width: 100%; height: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; background-color: #f9f9f9; overflow-y: auto; font-family: Arial, sans-serif; font-size: 14px; color: #333;">
        <!-- AI response will be displayed here -->
    </div>

                
            </div>
        </div>
          
    <!-- Include your JavaScript code -->
    <script>
        document.getElementById('getAiResponse').addEventListener('click', async function() {
            try {
                // Collect emissions and activities data
                const { emissionsData, activities } = await fetchEmissionsData();
    
                // Construct the prompt using emissions data and activities
                let activitiesList = activities.map(activity => {
                    return `${activity.activity} - ${activity.quantity} units, ${activity.emissions.toFixed(2)} kg CO2`;
                }).join('\n');
    
                const userInput = `I am trying to reduce my carbon emissions. My emissions data is as follows: 
                    ${activitiesList}
                    Total CO2 emissions: ${emissionsData.total.toFixed(2)} kg. What do I do?`;
    
                const response = await fetch('/get_ai_advice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ user_input: userInput })
                });
    
                // Check if the response is ok
                if (!response.ok) {
                    throw new Error('Network response was not ok.');
                }
    
                const data = await response.json();
                console.log('AI Response:', data.response);
                document.getElementById('aiResponse').textContent = data.response;
    
            } catch (error) {
                console.error('Error fetching AI response:', error);
                document.getElementById('aiResponse').textContent = "An error occurred while fetching AI response.";
            }
        });
    
        async function fetchEmissionsData() {
            var userId = "{{ user_id }}"; // Assuming user_id is passed from Flask
            const userActivitiesRef = db.collection("users").doc(userId).collection("activities");
            
            let emissionsData = {
                transportation: 0,
                food: 0,
                household: 0,
                manufacturing: 0,
                environmental: 0,
                total: 0
            };
            
            let activities = []; // To hold activity data
    
            const querySnapshot = await userActivitiesRef.get();
            if (querySnapshot.empty) {
                console.log('No matching documents.');
                return { emissionsData, activities };
            }
    
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                let category = data.category;
                let emissions = parseFloat(data.emissions); // Convert to number
                let quantity = parseFloat(data.quantity); // Convert to number
    
                // Store each activity
                activities.push({
                    activity: data.activity,
                    category: category,
                    emissions: emissions,
                    quantity: quantity
                });
    
                if (!isNaN(emissions) && !isNaN(quantity)) {
                    let totalEmissions = emissions * quantity;
                    if (emissionsData.hasOwnProperty(category)) {
                        emissionsData[category] += totalEmissions;
                    }
                    emissionsData.total += totalEmissions;
                }
            });
    
            return { emissionsData, activities };
        }
    
        // Existing code for chart initialization and fetching data remains unchanged...
    </script>

    <script>
        async function displayTodaysEmissionsSummary() {
            var userId = "{{ user_id }}"; // Assuming user_id is passed from Flask
            const userActivitiesRef = db.collection("users").doc(userId).collection("activities");
            
            // Get today's date
            const todayStart = new Date();
            todayStart.setHours(0, 0, 0, 0); // Start of today
    
            // Initialize emissions data for today
            let emissionsData = {
                transportation: 0,
                food: 0,
                household: 0,
                manufacturing: 0,
                environmental: 0,
                total: 0
            };
    
            // Fetch today's activities
            const querySnapshot = await userActivitiesRef
                .where("timestamp", ">=", todayStart) // Get records from today
                .get();
    
            if (querySnapshot.empty) {
                console.log('No matching documents for today.');
                return;
            }
    
            // Calculate total emissions by category for today
            querySnapshot.forEach((doc) => {
                let data = doc.data();
                let category = data.category;
                let emissions = parseFloat(data.emissions); // Convert to number
                let quantity = parseFloat(data.quantity); // Convert to number
    
                if (!isNaN(emissions) && !isNaN(quantity)) {
                    let totalEmissions = emissions * quantity;
                    if (emissionsData.hasOwnProperty(category)) {
                        emissionsData[category] += totalEmissions;
                    }
                    emissionsData.total += totalEmissions;
                }
            });
    
            // Display emissions summary
            let summary = `<h3>Today's Emissions Summary</h3>`;
            summary += `<p>Transportation: ${emissionsData.transportation.toFixed(2)} kg CO2</p>`;
            summary += `<p>Food: ${emissionsData.food.toFixed(2)} kg CO2</p>`;
            summary += `<p>Household: ${emissionsData.household.toFixed(2)} kg CO2</p>`;
            summary += `<p>Manufacturing: ${emissionsData.manufacturing.toFixed(2)} kg CO2</p>`;
            summary += `<p>Environmental: ${emissionsData.environmental.toFixed(2)} kg CO2</p>`;
            summary += `<p>Total Emissions for Today: ${emissionsData.total.toFixed(2)} kg CO2</p>`;
    
            // Create the chart
            createEmissionsChart(emissionsData);
        }
    
        function createEmissionsChart(emissionsData) {
            const ctx = document.getElementById('emissionsChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Transportation', 'Food', 'Household', 'Manufacturing', 'Environmental'],
                    datasets: [{
                        label: 'Emissions (kg CO2)',
                        data: [
                            emissionsData.transportation,
                            emissionsData.food,
                            emissionsData.household,
                            emissionsData.manufacturing,
                            emissionsData.environmental
                        ],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(153, 102, 255, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Emissions (kg CO2)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            
                        }
                    }
                }
            });
        }
    
        // Call the function to display today's emissions summary when the page loads
        document.addEventListener('DOMContentLoaded', displayTodaysEmissionsSummary);
    </script>
    
    <script>
     async function displayEmissionsPercentChange() {
    var userId = "{{ user_id }}"; // Assuming user_id is passed from Flask
    const userActivitiesRef = db.collection("users").doc(userId).collection("activities");

    // Get today's date range
    const todayStart = new Date();
    todayStart.setHours(0, 0, 0, 0); // Start of today
    const todayEnd = new Date();
    todayEnd.setHours(23, 59, 59, 999); // End of today

    // Get yesterday's date range
    const yesterdayStart = new Date();
    yesterdayStart.setDate(yesterdayStart.getDate() - 1); // Go back to yesterday
    yesterdayStart.setHours(0, 0, 0, 0); // Start of yesterday
    const yesterdayEnd = new Date();
    yesterdayEnd.setHours(23, 59, 59, 999); // End of yesterday

    let emissionsData = {
        today: {
            transportation: 0,
            food: 0,
            household: 0,
            manufacturing: 0,
            environmental: 0,
            total: 0
        },
        yesterday: {
            transportation: 0,
            food: 0,
            household: 0,
            manufacturing: 0,
            environmental: 0,
            total: 0
        }
    };

    // Fetch today's and yesterday's activities
    const todayQuery = userActivitiesRef.where("timestamp", ">=", todayStart).where("timestamp", "<=", todayEnd).get();
    const yesterdayQuery = userActivitiesRef.where("timestamp", ">=", yesterdayStart).where("timestamp", "<=", yesterdayEnd).get();

    // Process today's activities
    await todayQuery.then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            let data = doc.data();
            let category = data.category;
            let emissions = parseFloat(data.emissions) || 0; 
            let quantity = parseFloat(data.quantity) || 0; 

            if (!isNaN(emissions) && !isNaN(quantity)) {
                let totalEmissions = emissions * quantity;
                if (emissionsData.today.hasOwnProperty(category)) {
                    emissionsData.today[category] += totalEmissions;
                }
                emissionsData.today.total += totalEmissions;
            }
        });
    });

    // Process yesterday's activities
    await yesterdayQuery.then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            let data = doc.data();
            let category = data.category;
            let emissions = parseFloat(data.emissions) || 0; 
            let quantity = parseFloat(data.quantity) || 0; 

            if (!isNaN(emissions) && !isNaN(quantity)) {
                let totalEmissions = emissions * quantity;
                if (emissionsData.yesterday.hasOwnProperty(category)) {
                    emissionsData.yesterday[category] += totalEmissions;
                }
                emissionsData.yesterday.total += totalEmissions;
            }
        });
    });

    // Calculate percent change
    let percentChangeData = {
        transportation: 0,
        food: 0,
        household: 0,
        manufacturing: 0,
        environmental: 0,
        total: 0
    };

    // Calculate percent change
    for (let category of Object.keys(percentChangeData)) {
        const todayValue = emissionsData.today[category];
        const yesterdayValue = emissionsData.yesterday[category];

        // Calculate percent change
        if (yesterdayValue > 0) {
            percentChangeData[category] = ((todayValue - yesterdayValue) / yesterdayValue) * 100;
        } else {
            percentChangeData[category] = todayValue > 0 ? 100 : 0; // 100% if previously 0
        }
    }

    // Calculate total percent change
    const totalToday = emissionsData.today.total;
    const totalYesterday = emissionsData.yesterday.total;
    if (totalYesterday > 0) {
        percentChangeData.total = ((totalToday - totalYesterday) / totalYesterday) * 100;
    } else {
        percentChangeData.total = totalToday > 0 ? 100 : 0; // 100% if previously 0
    }

    // Display percent change summary
    let percentChangeSummary = `<h3>Percent Change in Emissions</h3>`;
    percentChangeSummary += `<p><strong>Today's Totals:</strong></p>`;
    percentChangeSummary += `<p>Transportation: ${emissionsData.today.transportation.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Food: ${emissionsData.today.food.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Household: ${emissionsData.today.household.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Manufacturing: ${emissionsData.today.manufacturing.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Environmental: ${emissionsData.today.environmental.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p><strong>Previous Day Totals:</strong></p>`;
    percentChangeSummary += `<p>Transportation: ${emissionsData.yesterday.transportation.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Food: ${emissionsData.yesterday.food.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Household: ${emissionsData.yesterday.household.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Manufacturing: ${emissionsData.yesterday.manufacturing.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p>Environmental: ${emissionsData.yesterday.environmental.toFixed(2)} kg</p>`;
    percentChangeSummary += `<p><strong>Percent Change:</strong></p>`;
    percentChangeSummary += `<p>Transportation: ${percentChangeData.transportation.toFixed(2)}%</p>`;
    percentChangeSummary += `<p>Food: ${percentChangeData.food.toFixed(2)}%</p>`;
    percentChangeSummary += `<p>Household: ${percentChangeData.household.toFixed(2)}%</p>`;
    percentChangeSummary += `<p>Manufacturing: ${percentChangeData.manufacturing.toFixed(2)}%</p>`;
    percentChangeSummary += `<p>Environmental: ${percentChangeData.environmental.toFixed(2)}%</p>`;
    percentChangeSummary += `<p><strong>Total Percent Change: ${percentChangeData.total.toFixed(2)}%</strong></p>`;

    // Create the percent change chart
    const ctx = document.getElementById('percentChart').getContext('2d');
    const percentChart = new Chart(ctx, {
        type: 'bar', // or 'line', 'pie', etc.
        data: {
            labels: ['Transportation', 'Food', 'Household', 'Manufacturing', 'Environmental', 'Total'],
            datasets: [{
                label: 'Percent Change (%)',
                data: [
                    percentChangeData.transportation,
                    percentChangeData.food,
                    percentChangeData.household,
                    percentChangeData.manufacturing,
                    percentChangeData.environmental,
                    percentChangeData.total
                ],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(153, 102, 255, 0.6)',
                    'rgba(255, 159, 64, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)'
                ],
                borderColor: [
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Percent Change (%)'
                    }
                }
            }
        }
    });
}

// Call the function on DOMContentLoaded
document.addEventListener('DOMContentLoaded', displayEmissionsPercentChange);

    </script>
    

    


    </div>
</body>
</html>
